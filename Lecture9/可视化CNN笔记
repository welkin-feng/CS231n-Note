课时 19-20

Understanding and Visualizing CNN

1. 可视化最能激活神经元的图片
	- 选择第5层中的任一神经元，然后传递大量图片给它，看哪个图片最能激活该神经元


2. 可视化filters/kernels
	- 可以得到经过类似gabor变换(滤波器)处理过的特征图
	- 可视化只能在第一层做，因为可以从原图片抓下来特征图，其他卷积层的可解释性较差


3. 可视化描述
	- 分类器前的全连接层有4096维特征向量，这4096维特征向量是对图片的一个概括.
	- 收集许多图片的特征向量并进行聚类即可得到相关性描述.
	t-SNE: 输入一个高维向量，它可根据数据内在关系进行聚类.
	遮挡实验: 使用遮挡滑动经过图像，观察遮挡的不同定位对分类为正确类别概率的影响.


4. 可视化神经元
	深度卷积神经网络的可视化工具，可实时可视化调试.
	1. 深度神经网络方法(Deconv 方法, Guided backpropagation)
		对于要考虑的神经元，将其后面的梯度设置为1，然后自当前层开始反向传播.


	2. 优化方法
		- 保持网络参数不变，通过优化输入的图片，在网络中最大化一个任意的分数(任意层的节点).
		- 简单来说，优化函数是找到一个图片I，使得分数Sc(I)最大，同时还有一个关于I的正则项.
		步骤:
			1. 输入一个全0的图片
			2. 将所有节点的梯度设置为0，我们感兴趣的那个节点的梯度设置为1，然后开始反向传播
			3. 对图片进行微小的更新
			4. 将图像再次输入到网络中
			5. 重复第2步


Q: 当我们作前向传播时，在分类器之前的fc层会得到一些特征，例如通过4096个数字组成的关于图像的概述，
   那么可以仅根据网络中的特征向量反推出原来的图像吗？
A: 卷积网络中，特征图的位置越往下层，预测(原图)的精度越低.


两个项目:
1. DeepDream
	输入一张图片到网络，并指定传递到哪一层，然后将终止层的特征图中的数值设置为梯度初值，并进行反向传播，最终更新原始图片.


2. NeuralStyle
	将一张图片变成另一张图片的风格
	- 输入两张图片，一张取内容，一张取风格，我们要把风格图的风格移植到内容图上.
		1. 提取内容目标: 把内容图输入到网络，记录卷积网络的原始激活(卷积网络中所有层的特征图和特征向量).
		2. 提取风格目标: 把风格图输入到网络，记录一种可以代表风格的统计信息(它不在原始激活中，而是在数据对中)，
		   即卷积网络中每一层特征向量的Gram矩阵，它跟踪了每一对特征是否在数据体内经常同时激活.
		   - 例如conv1输出[224x224x64]维特征向量，将其变为[50176x64]维，记为V，则其Gram矩阵为V.T * V，有[64x64]维.
		3. 通过两种损失(内容损失和风格损失)来优化图片，假设以任意一个图作为内容图做初始化，然后做前后向传播，
			希望激活与内容图匹配，每个激活的Gram矩阵与风格图匹配，但它们两个在后向传播时会打架，所以实际上内容图只用一层，风格图用很多层.
		4. 可以使用L-BFGS优化算法代替Adam，因为数据集不是很大，所以内存不会紧张，这是一个用单张图的优化问题，且只做后向传播.


Q: 能否用优化的图片去"骗"神经网络？
	- 使用大巴车的图片，将它的梯度设置为其它类别，比如鸵鸟，将大巴的梯度设置成和鸵鸟一样，然后做反向传播，得到了图像的变化，
	  这个变化并不会使大巴越来越像鸵鸟，事实上它的畸变效果并不明显，但却会使它被识别为鸵鸟.
	- 从随机噪声图片开始，可以以很高的置信度变为指定类别的东西.

	- 关于这个问题，有论文将其成为对抗样本. 实际上这种脆弱性的主要原因是我们在前向传播中用到函数的线性特性.

	线性特性: 图像是非常高维的，有很多像素，但在实际中训练的真实图像有特别的统计结构，所以只受很小一部分空间约束，
	         我们训练卷积网络在这个小空间内效果很好，图像的统计特征(特征图)很像图像，我们在图像顶部放一个线性函数，
	         在那个小的子空间内分类都是正确的，但在之外的空间内，对空间进行分割是完全随机的，因为在那里没有被训练过.
					 比如对于一个2层网络和2个类别的样本，在已知样本以外的区域，神经网络给出的空间划分是随机的，
					 对于更多类别的更高维数据，其样本集之外的区域划分可能更奇怪.


总结
	对图像进行反向传播是一个非常强的技术，例如:
		- Understanding，理解(如可视化任意节点的最大激活)
		- Segmenting，分割图像中的物体
		- Inverting，反推编码和引入隐私问题
		- Fun，娱乐(NeuralStyle/DeepDream)
		- Confusion and chaos，迷惑和混乱(对抗样本)